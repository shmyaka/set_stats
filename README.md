# Установка проекта

### Скачиваем проект
- Либо помощью команды __git clone git@github.com:shmyaka/set_stats.git__ (если есть ssh ключ)
- Либо помощью команды __git clone https://github.com/shmyaka/set_stats.git__ (если ssh ключа нет)
- Либо по ссылке __https://github.com/shmyaka/set_stats/archive/refs/heads/master.zip__

Для получаения проекта третьим способом на виртуальном сервере, выполняем команду:

```
wget https://github.com/shmyaka/set_stats/archive/refs/heads/master.zip
```

Распаковать архив можно утилитой __unzip__. 
Устанавливаем, если она не установлена:

```
sudo apt install unzip
```
Распаковываем архив:

```
unzip set_stats-master.zip
```
<br>
<hr>

### Создаём docker образ

- Если проект расположен на виртуальном сервере:

	- Заходим в каталог проекта (*set_stats-master, по-умолчанию*)
	- Создаём docker-образ с помощью команды:
    ```
    docker build -t $image_name .
    ```
- Если проект развёрнут на локальном компьютере:
	- Заходим в каталог проекта (*set_stats-master, по-умолчанию*)
	- Создаём docker-образ предназначенный для отпраки на docker-hub:
	```
    docker build -t $user_name/$image_name
    ```
    где 
    <br>
     	__$user_name__ - логин на сайте [hub.docker.co](https://hub.docker.com/)
    <br>
     	__$image_name__ - имя создаваемого образа
    - Заливаем образ на docker.hub:
    ```
    docker push $user_name/$image_name
	```
    - На виртуальном сервере обновить или получить впервые docker-образ **$user_name/$image_name** можно командой:
    ```
    docker pull $user_name/$image_name
    ```
<br>
<hr>


### Подготовка к запуску проекта

В корневой каталог проекта на виртуальном сервере (можем использовать каталог по-умолчанию, можем создать свой) копируем содержимое из папки **copy_to_server**

- в  **docker-compose.yml** описана инструкция запуска проекта в docker-compose:
  - Записываем root-пароль
  - Создаем пользователя Observer
  - Открываем порт 3306 для работы с mysql
  - Описываем связи между docker-контейнерами
  - Запускаем файл main.py
- В **my.cnf** какие-то конфигурационные данные для mysql (пока не знаю зачем, но оно работает)
- В **init.sql** ма даём полномочия для пользователя observer только лишь на чтение данных
- В **vars/vars.py** мы описываем, каким образом будет работать наш скрипт:
	- Если ***is_full_weeks = False***, тогда скрипт собирает статистику по самым популярным группам от ***start_count*** до ***stop_count***. Эти два показателя отображают порядковый номер сотни популярный групп, то есть 0 - это первая сотя. 1 - это группы с 101 по 200, и так далее. Для того, чтобы собрать статистику по 20к групп, нужно пройти примерно от ***start_count == 0*** до ***stop_count == 401***
	- Если ***is_full_weeks = True***, тогда скрипт ищет те периоды и группы в таблице статистики, которые "не заполнены", то есть данных об активности в этих группах и по этим периодам - отсутствуют. Собрав такие группы и такие периоды для этих групп, скрипт делает повторный запрос к VK API, и в случае успешного и "непустого" ответа - заносит эти данные БД.

Также в директории проекта автоматически создаётся каталог **logs/**, внутри которого записываются логи.

<br>
<hr>


### Запуск проекта

Находясь в дирректории проекта, вводим команду:
```
docker-compose up
```

Для просмотра лога запущенного docker-compose, вводим команду:
```
docker-compose logs -f
```

Для завершения проекта запускаем:
```
docker-compose down
```

Для работы с mysql внутри запущенного контейнера:
```
docker exec -it $container_id mysql -p
```

Узнать **$container_id** можно с помощью команды:
```
docker ps
```

Чтобы сделать dump базы данных (***$database_name*** - нужное имя базы данных, которую мы хотим получить) из запущенного docker-контейнера:
```
docker exec $container_id /usr/bin/mysqldump -u root --password=$root_rassword $database_name > backup.sql
```
